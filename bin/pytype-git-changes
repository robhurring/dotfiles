#!/usr/bin/env bash
set -euo pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}==>${NC} $1"
}

detail() {
    echo -e "${GREEN}-->${NC} $1"
}

item() {
    echo "   $1"
}

warn() {
    echo -e "${YELLOW}==>${NC} $1"
}

error() {
    echo -e "${RED}==>${NC} $1" >&2
    exit 1
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
fi

# Determine the actual branch to compare against
get_comparison_branch() {
    local base_branch="${1:-origin/main}"
    
    # Try different common main branch names
    if ! git rev-parse --verify "$base_branch" > /dev/null 2>&1; then
        for branch in "origin/master" "main" "master"; do
            if git rev-parse --verify "$branch" > /dev/null 2>&1; then
                base_branch="$branch"
                break
            fi
        done
    fi
    
    echo "$base_branch"
}

# Get changed Python files
get_changed_python_files() {
    local base_branch="$1"
    
    # Get all changed Python files
    git diff --name-only "$base_branch" | \
        grep -E '\.(py)$' || true
}

# Detect Python environment and pytype command
detect_pytype_command() {
    if command -v uv > /dev/null 2>&1 && [ -f "pyproject.toml" ]; then
        echo "uv run pytype"
    elif [ -f "poetry.lock" ] && command -v poetry > /dev/null 2>&1; then
        echo "poetry run pytype"
    elif [ -n "${VIRTUAL_ENV:-}" ] || [ -f "venv/bin/activate" ] || [ -f ".venv/bin/activate" ]; then
        if [ -z "${VIRTUAL_ENV:-}" ]; then
            # Activate venv if it exists
            if [ -f ".venv/bin/activate" ]; then
                source .venv/bin/activate
            elif [ -f "venv/bin/activate" ]; then
                source venv/bin/activate
            fi
        fi
        echo "pytype"
    else
        echo "pytype"
    fi
}

# Main execution
main() {
    local base_branch="${1:-}"
    
    log "Finding changed Python files..."
    
    # Determine the actual branch to compare against
    local actual_branch
    actual_branch=$(get_comparison_branch "$base_branch")
    
    # Get changed Python files
    mapfile -t python_files < <(get_changed_python_files "$actual_branch")
    
    if [ ${#python_files[@]} -eq 0 ]; then
        warn "No Python files changed (compared to $actual_branch)"
        exit 0
    fi
    
    detail "Found ${#python_files[@]} changed Python file(s) compared to $actual_branch"
    for file in "${python_files[@]}"; do
        item "$file"
    done
    echo
    
    # Detect pytype command
    pytype_cmd=$(detect_pytype_command)
    
    log "Running $pytype_cmd"
    echo
    
    # Execute pytype - use array to handle multi-word commands properly
    cmd_array=($pytype_cmd)
    "${cmd_array[@]}" --keep-going --jobs auto "${python_files[@]}"
}

# Show usage if --help is passed
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    cat << EOF
Usage: pytype-git-changes [BASE_BRANCH]

Run pytype on Python files that have changed compared to a base branch.

Arguments:
  BASE_BRANCH    Base branch to compare against (default: origin/main)

The script will automatically detect and use:
  - uv (if pyproject.toml exists)
  - poetry (if poetry.lock exists)  
  - virtual environment (if activated or venv//.venv directories exist)
  - system pytype (as fallback)

Examples:
  pytype-git-changes
  pytype-git-changes origin/develop
  pytype-git-changes main
EOF
    exit 0
fi

main "$@"